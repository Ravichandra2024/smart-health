<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Heart Rate Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
  <div id="chart"></div>
  <h1 id="xy"></h1>
  <h1 id="average"></h1>
  <h1 id="problem"></h1>
  <script>
    var data = [];
    var t = [];
    var o = 0;
    var j = 60;
    var h, k, l, u;
    var options = {
      series: [{
        data: data.slice()
      }],
      chart: {
        id: 'realtime',
        height: 350,
        type: 'line',
        animations: {
          enabled: true,
          easing: 'linear',
          dynamicAnimation: {
            speed: 1000
          }
        },
        toolbar: {
          show: false
        },
        zoom: {
          enabled: false
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        curve: 'smooth'
      },
      title: {
        text: 'Heart Rate',
        align: 'left'
      },
      markers: {
        size: 0
      },
      xaxis: {
        type: 'datetime',
        labels: {
          formatter: function (value, timestamp) {
            var date = new Date(value);
            return date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
          }
        }
      },
      yaxis: {
        labels: {
          formatter: function (value) {
            return value.toFixed(2);
          }
        }
      },
      legend: {
        show: false
      },
    };
    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();

    function getNewSeries() {
      fetch('/heart_rate')
        .then(response => response.json())
        .then(newData => {
          var heartRate = newData.heart_rate;
          data.push({ x: new Date().getTime(), y: heartRate });
          if (data.length > 10) {
            data.shift();
          }
          chart.updateOptions({
            yaxis: {
              min: Math.min(...data.map(item => item.y)),
              max: Math.max(...data.map(item => item.y))
            }
          });
          chart.updateSeries([{ data: data }]);
          document.querySelector("#xy").innerHTML = "Heart rate is:" + heartRate;
          t.push(heartRate);
          if (t.length === 60) {
            h = calculateAverage(data.slice(o, j));
            k = calculateStandardDeviation(data.slice(o, j));
            l = (45 - h) / k;
            u = (125 - h) / k;
            document.querySelector("#problem").innerHTML = "The average heart rate:" + (h-40);
            if (l > -1000) {
              document.querySelector("#problem").innerHTML = "The person's heart rate is normal";
            } else {
              document.querySelector("#problem").innerHTML = "The person has a problem";
            }
            o = o + 60;
            j = j + 60;
            t = [];
          }
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
    }

    getNewSeries();
    window.setInterval(function () {
      getNewSeries();
    }, 1000);


    
    function calculateAverage(numbers) {
      if (numbers.length === 0) {
        return null;
      }
      const sum = numbers.reduce((acc, num) => acc + num.y, 0);
      return sum / numbers.length;
    }

    function calculateStandardDeviation(numbers) {
      if (numbers.length < 2) {
        return null;
      }
      const average = calculateAverage(numbers);
      const squaredDifferences = numbers.map(num => Math.pow(num.y - average, 2));
      const averageSquaredDifference = calculateAverage(squaredDifferences);
      const standardDeviation = Math.sqrt(averageSquaredDifference);
      return standardDeviation;
    }
  </script>
</body>

</html>